---
runId: 36660a
feature: admin-live-winner-marking
created: 2025-01-21
status: ready
---

# Feature: Live Winner Marking for Game Admin - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/36660a-admin-live-winner-marking/spec.md
> **Created:** 2025-01-21

## Execution Summary

- **Total Tasks**: 3
- **Total Phases**: 3
- **Sequential Time**: 15h
- **Parallel Time**: 15h
- **Time Savings**: 0h (0%)

**Parallel Opportunities:**
None - All phases sequential due to layer dependencies (Models → Actions → UI)

---

## Phase 1: Models & Services Layer

**Strategy**: Sequential
**Reason**: Foundation layer - all other tasks depend on this

### Task 1.1: Models & Services Layer

**Files**:
- `src/lib/models/pick.ts`
- `src/lib/services/category-service.ts`

**Complexity**: M (4h)

**Dependencies**: None

**Description**:
Implement the data access and business logic layers for live winner marking. Add pick count aggregation to the pick model (scoped by game and category), and add winner marking/clearing operations to the category service. This provides the foundation for the API and UI layers.

**Implementation Steps**:

1. **Add pick count aggregation to pick model**:
   - Open `src/lib/models/pick.ts`
   - Add `getPickCountsByCategory(gameId: string, categoryId: string)` function
   - Use Prisma `groupBy`: `groupBy({ by: ['nominationId'], where: { gameId, categoryId }, _count: { id: true } })`
   - Return type: `Promise<Array<{ nominationId: string; count: number }>>`
   - Add JSDoc with example usage

2. **Add winner marking to category service**:
   - Open `src/lib/services/category-service.ts`
   - Add `markWinner(categoryId: string, nominationId: string)` function
   - Validates nomination belongs to category (call categoryModel to check)
   - Calls `categoryModel.update(categoryId, { winnerNominationId, isRevealed: true })`
   - Returns updated category

3. **Add winner clearing to category service**:
   - Add `clearWinner(categoryId: string)` function
   - Calls `categoryModel.update(categoryId, { winnerNominationId: null, isRevealed: false })`
   - Returns updated category

4. **Write tests**:
   - Test pick count aggregation with multiple games and categories
   - Test mark winner validates nomination belongs to category
   - Test clear winner sets both fields to null/false

**Acceptance Criteria**:
- [ ] `getPickCountsByCategory` returns correct counts scoped to game+category
- [ ] `markWinner` sets both `winnerNominationId` AND `isRevealed: true`
- [ ] `clearWinner` sets both `winnerNominationId: null` AND `isRevealed: false`
- [ ] `markWinner` validates nomination belongs to category (throws error if not)
- [ ] All model/service tests pass

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Layer boundaries** (architecture.md):
  - Models: Prisma queries only, no business logic
  - Services: Business logic, calls models (never Prisma directly)
  - No circular dependencies

- **Required patterns** (patterns.md):
  - Models return Prisma types directly
  - Services use Zod for internal validation
  - No `as` type assertions without validation

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:
```bash
pnpm biome check --write src/lib/models/pick.ts src/lib/services/category-service.ts
pnpm test src/lib/models/pick.test.ts src/lib/services/category-service.test.ts
```

---

## Phase 2: API Layer

**Strategy**: Sequential
**Reason**: Depends on Phase 1 (services), required by Phase 3 (UI)

### Task 2.1: API Layer (Actions + Routes)

**Files**:
- `src/lib/actions/admin-actions.ts`
- `src/lib/routes.ts`

**Complexity**: M (4h)

**Dependencies**: Task 1.1 (needs categoryService.markWinner/clearWinner)

**Description**:
Create the server action API surface for live winner marking. Add `markWinnerAction` and `clearWinnerAction` using the `adminAction` client (ADMIN role middleware) with Zod validation. Also add the centralized route definition for the live page to `routes.ts`.

**Implementation Steps**:

1. **Add route to routes.ts**:
   - Open `src/lib/routes.ts`
   - Add to `admin.games` object: `live: (gameId: string) => \`/admin/games/\${gameId}/live\``
   - Verify type safety (should autocomplete in imports)

2. **Create markWinnerAction**:
   - Open `src/lib/actions/admin-actions.ts`
   - Import `adminAction` client (ADMIN role middleware)
   - Create schema: `z.object({ categoryId: z.string(), nominationId: z.string() })`
   - Use `adminAction.schema(schema).action(async ({ parsedInput }) => { ... })`
   - Call `categoryService.markWinner(parsedInput.categoryId, parsedInput.nominationId)`
   - Return success with updated category
   - Error handling: catch validation errors from service

3. **Create clearWinnerAction**:
   - Create schema: `z.object({ categoryId: z.string() })`
   - Use `adminAction.schema(schema).action(async ({ parsedInput }) => { ... })`
   - Call `categoryService.clearWinner(parsedInput.categoryId)`
   - Return success with updated category

4. **Write action tests**:
   - Test mark winner action validates schema (reject invalid inputs)
   - Test clear winner action validates schema
   - Test actions require ADMIN role (reject non-admin users)
   - Test actions call service layer correctly

**Acceptance Criteria**:
- [ ] `routes.admin.games.live(gameId)` returns correct path
- [ ] `markWinnerAction` uses `adminAction` client (ADMIN role required)
- [ ] `clearWinnerAction` uses `adminAction` client (ADMIN role required)
- [ ] Both actions validate inputs with Zod schemas
- [ ] Actions return success/error following next-safe-action pattern
- [ ] All action tests pass

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **next-safe-action** (patterns.md):
  - All server actions use `adminAction` client
  - Zod schemas for validation
  - No raw server actions
  - Error handling via returnValidationErrors

- **Centralized routes** (patterns.md):
  - ALL navigation uses `routes.ts`
  - Type-safe parameters
  - No hardcoded route strings

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:
```bash
pnpm biome check --write src/lib/actions/admin-actions.ts src/lib/routes.ts
pnpm test src/lib/actions/admin-actions.test.ts
```

---

## Phase 3: UI Layer

**Strategy**: Sequential
**Reason**: Depends on Phase 2 (actions/routes), final integration

### Task 3.1: UI Layer (Components + Page + Navigation)

**Files**:
- `src/components/admin/games/category-card.tsx`
- `src/app/(admin)/admin/games/[gameId]/live/page.tsx`
- `src/app/(admin)/admin/games/[gameId]/page.tsx`

**Complexity**: L (7h)

**Dependencies**: Task 2.1 (needs markWinnerAction, clearWinnerAction, routes.admin.games.live)

**Description**:
Build the complete UI layer for live winner marking: create the CategoryCard client component with dropdown and clear button, create the live page server component that fetches and displays all categories with pick counts, and add navigation from the game detail page. This completes the end-to-end feature.

**Implementation Steps**:

1. **Create CategoryCard client component**:
   - Create `src/components/admin/games/category-card.tsx`
   - Add `"use client"` directive (needs event handlers)
   - Props: `{ category, nominations: Array<{ id, title, pickCount }>, currentWinner?: string }`
   - Display category name, point value, reveal status
   - Show nominations sorted by pickCount descending: "Nomination Title (X picks)"
   - Dropdown (`<select>`) with all nomination titles
   - Use `useAction(markWinnerAction)` for dropdown onChange
   - Clear button uses `useAction(clearWinnerAction)` for onClick
   - Visual indicator when winner marked: "Current: {nomination} ✓"
   - Error message display if action fails
   - Disabled state if no nominations

2. **Create live page server component**:
   - Create `src/app/(admin)/admin/games/[gameId]/live/page.tsx`
   - Import `requireValidatedSession` from `@/lib/auth/config`
   - Props type: `{ params: Promise<{ gameId: string }> }`
   - **IMPORTANT**: Await params before accessing (Next.js 15): `const { gameId } = await params;`
   - Call `requireValidatedSession()` and verify ADMIN role
   - Fetch game with event and categories (ordered by `order` ASC)
   - For each category, fetch pick counts: `pickModel.getPickCountsByCategory(gameId, categoryId)`
   - Fetch nominations for each category
   - Merge pick counts with nominations (default count: 0)
   - Render breadcrumb: "Games > {Game Name} > Live"
   - Render category list (vertical scroll)
   - Map categories to `<CategoryCard>` components
   - Back link to game detail using `routes.admin.games.detail(gameId)`

3. **Add navigation to game detail page**:
   - Open `src/app/(admin)/admin/games/[gameId]/page.tsx`
   - Add "Live Winner Marking" button/link
   - Use `routes.admin.games.live(gameId)` for href
   - Position near other admin actions

4. **Write component/page tests**:
   - Test CategoryCard displays nominations sorted by pick count
   - Test CategoryCard dropdown calls markWinnerAction
   - Test CategoryCard clear button calls clearWinnerAction
   - Test CategoryCard shows current winner indicator
   - Test live page requires ADMIN role (redirects non-admin)
   - Test live page displays categories ordered by `order` field
   - Test live page handles no nominations gracefully

5. **Manual testing checklist**:
   - Navigate to game detail, click "Live Winner Marking"
   - Verify categories ordered by `order` ascending
   - Verify pick counts accurate (test with multiple users)
   - Select nomination from dropdown → verify winner marked AND revealed
   - Verify "Current: {nomination} ✓" appears
   - Click clear → verify winner removed AND unrevealed
   - Test on tablet viewport (mobile compatibility)
   - Test with categories that have no nominations

**Acceptance Criteria**:
- [ ] CategoryCard is a Client Component (`"use client"`)
- [ ] Live page is a Server Component (async, fetches data)
- [ ] Live page awaits params before accessing (Next.js 15 requirement)
- [ ] Live page uses `requireValidatedSession()` + ADMIN role check
- [ ] Categories ordered by `Category.order` ascending
- [ ] Nominations sorted by pick count descending within each category
- [ ] Pick counts scoped to the specific game (not all games)
- [ ] Dropdown selection marks winner AND reveals in one action
- [ ] Clear button removes winner AND unreveals
- [ ] "Current: {nomination} ✓" shown for marked categories
- [ ] Error message displayed if action fails
- [ ] Categories with no nominations show disabled state
- [ ] Back link uses `routes.admin.games.detail(gameId)`
- [ ] "Live Winner Marking" link added to game detail page uses `routes.admin.games.live(gameId)`
- [ ] Mobile/tablet layout works (vertical scroll, native select)
- [ ] All component tests pass
- [ ] Manual testing on dev environment passes

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Server/Client boundaries** (patterns.md):
  - CategoryCard: Client Component (event handlers, useAction)
  - Live page: Server Component (async, fetches data)
  - No event handlers in Server Components

- **Async params** (patterns.md):
  - Next.js 15: `params` is Promise, MUST await before accessing
  - Props type: `{ params: Promise<{ gameId: string }> }`
  - Usage: `const { gameId } = await params;`

- **Authentication** (patterns.md):
  - Use `requireValidatedSession()` (not raw `auth()`)
  - Validates JWT + user exists in DB
  - Role check: `session.user.role === 'ADMIN'`

- **Centralized routes** (patterns.md):
  - ALL navigation uses `routes.ts`
  - No hardcoded route strings

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:
```bash
pnpm biome check --write src/components/admin/games/ src/app/\(admin\)/admin/games/
pnpm test src/components/admin/games/category-card.test.tsx
pnpm dev  # Manual testing
```

---

## Final Verification

After all phases complete:

```bash
# Lint all changes
pnpm biome check --write .

# Run full test suite
pnpm test

# Build to verify no type errors
pnpm build

# Manual end-to-end testing
pnpm dev
# 1. Sign in as admin (email in ADMIN_EMAILS)
# 2. Navigate to /admin/games/[gameId]
# 3. Click "Live Winner Marking"
# 4. Verify all acceptance criteria from spec (lines 168-207)
```

**Constitution Compliance Checklist**:
- [ ] All patterns followed (next-safe-action, requireValidatedSession, centralized routes, Server/Client boundaries, async params)
- [ ] Architecture boundaries respected (Models → Services → Actions → UI, no Prisma in Services)
- [ ] Testing requirements met (Models, Services, Actions, Components all tested)

**Feature-Specific Checklist** (from spec lines 188-201):
- [ ] Navigate to `/admin/games/[gameId]/live` shows category list
- [ ] Categories ordered by `order` field ascending
- [ ] Each category shows nominations sorted by pick count descending
- [ ] Pick counts accurate for that game's picks only
- [ ] Dropdown shows all nominations for category (titles only)
- [ ] Selecting nomination from dropdown marks winner AND reveals
- [ ] Marked categories show "Current: {nomination} ✓"
- [ ] Clear button removes winner AND unreveals
- [ ] Error message displayed if server action fails
- [ ] Categories with no nominations show disabled state
- [ ] Back link returns to game detail page
- [ ] Non-admin users redirected (ADMIN role required)
- [ ] "Live Winner Marking" link added to game detail page

---

## Notes

**No schema changes required** - Uses existing fields:
- `Category.winnerNominationId` (nullable string)
- `Category.isRevealed` (boolean)
- `Category.order` (int)

**No new dependencies required** - All tech already in stack:
- next-safe-action (server actions)
- Zod (validation)
- Tailwind CSS (styling)
- Prisma (aggregation queries)

**Performance considerations**:
- Pick count aggregation: Single batch query for all categories (avoid N+1)
- Existing index on `Pick[gameId]` and `Pick[categoryId]` sufficient
- No real-time updates needed (page refresh after action)

**Mobile compatibility**:
- Vertical scroll layout
- Native `<select>` element (mobile-friendly)
- Test on iPad viewport during manual testing
