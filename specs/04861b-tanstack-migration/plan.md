# Feature: TanStack Migration - Implementation Plan

> **Generated by:** Task Decomposition skill (spectacular:decomposing-tasks)
> **From spec:** specs/04861b-tanstack-migration/spec.md
> **Created:** 2025-10-30
> **Run ID:** 04861b
> **Feature:** tanstack-migration

---

**Target Repository:** `/Users/drewritter/projects/bignight.party-no_nextjs/`
**Source Repository:** `/Users/drewritter/projects/bignight.party/`

---

## Execution Summary

- **Total Tasks**: 17
- **Total Phases**: 5
- **Sequential Time**: 82h
- **Parallel Time**: 58h
- **Time Savings**: 24h (29% faster with parallelization)**

**Parallel Opportunities:**

- Phase 2: 3 tasks (6h saved)
- Phase 4: 4 tasks (18h saved)

**Complexity Breakdown:**
- L (5-7h): 8 tasks
- M (3-5h): 9 tasks
- S (1-2h): 0 tasks

---

## Phase 1: Infrastructure Foundation

**Strategy**: Sequential
**Reason**: Each task builds on previous foundation (package.json → configs → schema)
**Phase Time**: 15h (sequential only)

### Task 1.1: Bun + TanStack Start + Vite Setup

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/package.json`
- `/Users/drewritter/projects/bignight.party-no_nextjs/vite.config.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/tsconfig.json`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/client.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/server.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/.gitignore`
- `/Users/drewritter/projects/bignight.party-no_nextjs/README.md`

**Complexity**: M (4h)

**Dependencies**: None (foundation task)

**Description**:
Initialize new Bun project with TanStack Start framework, Vite build tooling, and React 19. This task sets up the foundation for the entire migration by installing core dependencies and configuring the build system.

**Implementation Steps**:

1. Initialize Bun project: `bun init` in new repo directory
2. Install core dependencies:
   - `@tanstack/start` - SSR framework
   - `@tanstack/react-router` - File-based routing
   - `@tanstack/nitro-v2-vite-plugin` - Nitro with Bun preset (REQUIRED)
   - `react@19.0.0` `react-dom@19.0.0` - React 19 (REQUIRED for Bun hosting)
   - `vite@6.x` - Build tool
   - `@vitejs/plugin-react` - React plugin
3. Configure Vite with Nitro plugin (Bun preset):
   ```typescript
   import { tanstackStart } from '@tanstack/react-start/plugin/vite'
   import { defineConfig } from 'vite'
   import viteReact from '@vitejs/plugin-react'
   import { nitroV2Plugin } from '@tanstack/nitro-v2-vite-plugin'

   export default defineConfig({
     plugins: [
       tanstackStart(),
       nitroV2Plugin({ preset: 'bun' }), // REQUIRED for Bun
       viteReact(),
     ],
   })
   ```
4. Create TypeScript config extending TanStack Start defaults
5. Create entry points: `app/client.tsx` and `app/server.tsx`
6. Add package.json scripts: `dev`, `build`, `start`
7. Create `.gitignore` (`.output/`, `node_modules/`, `.env.local`)
8. Verify dev server starts: `bun run dev`

**Acceptance Criteria**:
- [ ] Bun runtime version 1.x installed
- [ ] React 19.0.0+ installed (verified in package.json)
- [ ] Vite dev server starts without errors: `bun run dev`
- [ ] Nitro plugin configured with Bun preset (verified in vite.config.ts)
- [ ] Build outputs to `.output/server/index.mjs`: `bun run build`
- [ ] TypeScript compilation passes: `bun run tsc --noEmit`
- [ ] Hot module replacement works (test by editing app/client.tsx)

**Mandatory Patterns**:

> **Constitution**: This is a NEW project without existing constitution. Follow TanStack Start best practices from official docs.

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run dev  # Should start without errors
bun run build  # Should output to .output/server/index.mjs
```

---

### Task 1.2: Better-Auth Configuration

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/auth/config.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/auth/client.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/types/auth.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/.env.example`
- `/Users/drewritter/projects/bignight.party-no_nextjs/package.json` (add dependencies)

**Complexity**: M (4h)

**Dependencies**: Task 1.1 (needs package.json)

**Description**:
Set up Better-Auth for passwordless magic link authentication using Prisma adapter for session storage. This replaces the Next.js Auth.js setup with a Bun-compatible solution.

**Implementation Steps**:

1. Install Better-Auth dependencies:
   - `better-auth` - Core auth library
   - `@better-auth/prisma-adapter` - Prisma session storage
   - `resend` - Email delivery (unchanged from Next.js version)
2. Create Better-Auth configuration in `server/auth/config.ts`:
   - Magic link provider with Resend
   - Prisma adapter for session storage
   - Admin role assignment based on `ADMIN_EMAILS` env variable
   - Session cookie configuration
3. Create auth client for server-side usage (`server/auth/client.ts`)
4. Define auth types in `shared/types/auth.ts`:
   - `User` type with id, email, role
   - `Session` type with user and metadata
   - Role enum: `USER | ADMIN`
5. Copy environment variables from old project:
   - `AUTH_SECRET` (generate new with `openssl rand -base64 32`)
   - `RESEND_API_KEY` (unchanged)
   - `EMAIL_FROM` (unchanged)
   - `ADMIN_EMAILS` (comma-separated list)
6. Create `.env.example` template
7. Test magic link generation (manual test with console.log)

**Acceptance Criteria**:
- [ ] Better-Auth installed and configured
- [ ] Magic link provider uses Resend API
- [ ] Prisma adapter configured (session storage)
- [ ] Admin role assigned based on `ADMIN_EMAILS` environment variable
- [ ] Session cookie settings secure (httpOnly, sameSite, secure in production)
- [ ] `.env.example` documents all required auth variables
- [ ] Types exported from `shared/types/auth.ts` match Better-Auth schema

**Mandatory Patterns**:

> **Better-Auth Docs**: https://www.better-auth.com/docs/authentication/magic-link

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

### Task 1.3: Prisma Schema Migration

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/prisma/schema.prisma`
- `/Users/drewritter/projects/bignight.party-no_nextjs/prisma/migrations/` (copy entire directory)
- `/Users/drewritter/projects/bignight.party-no_nextjs/prisma/seed.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/db/prisma.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/package.json` (add Prisma scripts)

**Complexity**: M (3h)

**Dependencies**: Task 1.1 (needs package.json)

**Description**:
Copy existing Prisma schema and migrations from Next.js project to new TanStack project. The database schema remains unchanged - this is purely a file copy and configuration task.

**Implementation Steps**:

1. Install Prisma dependencies:
   - `prisma` - CLI tool
   - `@prisma/client` - Client library
2. Copy `prisma/schema.prisma` from old project (exact copy, no modifications)
3. Copy entire `prisma/migrations/` directory (preserve migration history)
4. Copy `prisma/seed.ts` (seed script unchanged)
5. Create Prisma client singleton in `server/db/prisma.ts`:
   ```typescript
   import { PrismaClient } from '@prisma/client'

   const globalForPrisma = globalThis as unknown as {
     prisma: PrismaClient | undefined
   }

   export const prisma = globalForPrisma.prisma ?? new PrismaClient()

   if (process.env.NODE_ENV !== 'production') {
     globalForPrisma.prisma = prisma
   }
   ```
6. Add package.json scripts:
   - `db:generate` - Generate Prisma client
   - `db:migrate` - Run migrations
   - `db:push` - Push schema changes
   - `db:studio` - Open Prisma Studio
   - `db:seed` - Seed database
7. Set up environment variable: `DATABASE_URL` in `.env.local`
8. Test: Run migrations against clean database

**Acceptance Criteria**:
- [ ] Prisma schema copied exactly from old project
- [ ] All migrations copied (verify count matches old project)
- [ ] Seed script copied and executable
- [ ] Prisma client generates successfully: `bun run db:generate`
- [ ] Migrations run cleanly on fresh database: `bun run db:migrate`
- [ ] Prisma Studio opens: `bun run db:studio`
- [ ] Seed script runs without errors: `bun run db:seed`

**Mandatory Patterns**:

> **Source**: Copy from `/Users/drewritter/projects/bignight.party/prisma/`

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run db:generate  # Should succeed
bun run db:migrate  # Should apply all migrations
bun run db:seed  # Should populate database
```

---

### Task 1.4: tRPC Router Foundation

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/trpc.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/context.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/index.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/utils/trpc.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/package.json` (add tRPC dependencies)

**Complexity**: M (4h)

**Dependencies**: Task 1.1 (needs package.json), Task 1.2 (needs auth), Task 1.3 (needs Prisma)

**Description**:
Set up tRPC server and client infrastructure with request context including Better-Auth session and Prisma client. This replaces Next.js Server Actions with type-safe RPC procedures.

**Implementation Steps**:

1. Install tRPC dependencies:
   - `@trpc/server` - Server-side tRPC
   - `@trpc/client` - Client-side tRPC
   - `@trpc/react-query` - React Query integration
   - `@tanstack/react-query` - React Query core
2. Create request context (`server/api/context.ts`):
   - Include Better-Auth session (authenticated user)
   - Include Prisma client
   - Include request metadata (headers, IP)
3. Create tRPC router setup (`server/api/trpc.ts`):
   - Base procedure (public)
   - Protected procedure (requires authentication)
   - Admin procedure (requires ADMIN role)
4. Create root router (`server/api/routers/index.ts`):
   - Empty router structure (placeholder for Phase 3)
   - Export `AppRouter` type for client inference
5. Create client-side tRPC utils (`app/utils/trpc.ts`):
   - React Query client setup
   - tRPC client with HTTP link
   - Export typed hooks: `trpc.useQuery`, `trpc.useMutation`
6. Add tRPC HTTP handler to server (placeholder in `app/server.tsx`)
7. Test: Call empty router from client (should return empty object)

**Acceptance Criteria**:
- [ ] tRPC server initialized with context (auth + Prisma)
- [ ] Protected procedure middleware validates authentication
- [ ] Admin procedure middleware validates ADMIN role
- [ ] Client-side tRPC hooks available (`trpc.useQuery`, `trpc.useMutation`)
- [ ] Type inference works end-to-end (client knows server types)
- [ ] HTTP handler responds to `/api/trpc` endpoint
- [ ] Test query succeeds (empty router returns {})

**Mandatory Patterns**:

> **tRPC Docs**: https://trpc.io/docs/server/context
> **Better-Auth Integration**: Use `auth.api.getSession()` in context

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
bun run dev  # Server starts with tRPC handler
```

---

## Phase 2: Business Logic Porting

**Strategy**: Parallel
**Reason**: All tasks port independent files from old project with no shared files
**Phase Time**: 6h (parallel execution) vs 15h (sequential)
**Time Savings**: 9h (60% faster)

### Task 2.1: Port Models Layer

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/user.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/event.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/game.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/category.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/nomination.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/pick.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/gameParticipant.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/work.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/person.ts`

**Complexity**: L (6h)

**Dependencies**: Phase 1 (needs Prisma client)

**Description**:
Port all data access layer files from `src/lib/models/` to `server/models/`. Models are pure Prisma queries with no business logic, so they port directly with only import path changes.

**Implementation Steps**:

1. Copy all files from `/Users/drewritter/projects/bignight.party/src/lib/models/` to `/Users/drewritter/projects/bignight.party-no_nextjs/server/models/`
2. Update imports in each file:
   - `@/lib/db/prisma` → `@/server/db/prisma`
   - `@prisma/client` (unchanged)
3. Verify each model file:
   - No business logic (only Prisma queries)
   - Exports functions like `findById`, `create`, `update`, `delete`
   - No Next.js dependencies
4. Create barrel export: `server/models/index.ts`
5. Run type checking on all model files
6. Document model responsibilities in comments

**Source Files** (copy from old project):
- `src/lib/models/user.ts`
- `src/lib/models/event.ts`
- `src/lib/models/game.ts`
- `src/lib/models/category.ts`
- `src/lib/models/nomination.ts`
- `src/lib/models/pick.ts`
- `src/lib/models/gameParticipant.ts`
- `src/lib/models/work.ts`
- `src/lib/models/person.ts`

**Acceptance Criteria**:
- [ ] All 9 model files copied and updated
- [ ] Import paths reference new project structure
- [ ] No Next.js dependencies remain
- [ ] Barrel export (`server/models/index.ts`) exports all models
- [ ] TypeScript compilation passes for all models
- [ ] Each model file has documentation comments
- [ ] Models only contain Prisma queries (no business logic)

**Mandatory Patterns**:

> **Model Layer**: Pure data access, no business logic, only Prisma queries

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

### Task 2.2: Port Services Layer

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/auth.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/event.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/game.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/pick.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/leaderboard.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/admin.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/work.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/person.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/import.ts`

**Complexity**: L (6h)

**Dependencies**: Phase 1 (needs Prisma), Task 2.1 (calls models)

**Description**:
Port all business logic layer files from `src/lib/services/` to `server/services/`. Services orchestrate models and contain business rules, so they need import updates and WebSocket event handling preserved.

**Implementation Steps**:

1. Copy all files from `/Users/drewritter/projects/bignight.party/src/lib/services/` to `/Users/drewritter/projects/bignight.party-no_nextjs/server/services/`
2. Update imports in each file:
   - `@/lib/models/*` → `@/server/models/*`
   - `@/types/*` → `@/shared/types/*`
   - Remove any Next.js-specific imports (e.g., `next/cache`)
3. Preserve WebSocket event emission logic:
   - Services emit Socket.io events (same pattern as Next.js version)
   - Event emission handled in Phase 5 (Socket.io integration)
4. Update error handling if needed (remove Next.js-specific errors)
5. Create barrel export: `server/services/index.ts`
6. Run type checking on all service files
7. Verify business logic unchanged (manual code review)

**Source Files** (copy from old project):
- `src/lib/services/auth.ts`
- `src/lib/services/event.ts`
- `src/lib/services/game.ts`
- `src/lib/services/pick.ts`
- `src/lib/services/leaderboard.ts`
- `src/lib/services/admin.ts`
- `src/lib/services/work.ts`
- `src/lib/services/person.ts`
- `src/lib/services/import.ts`

**Acceptance Criteria**:
- [ ] All 9 service files copied and updated
- [ ] Import paths reference new project structure
- [ ] No Next.js dependencies remain
- [ ] Business logic unchanged (verified via code review)
- [ ] WebSocket event emission preserved (placeholder for Phase 5)
- [ ] Barrel export (`server/services/index.ts`) exports all services
- [ ] TypeScript compilation passes for all services

**Mandatory Patterns**:

> **Service Layer**: Business logic only, calls models, emits events, no direct Prisma

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

### Task 2.3: Port Shared Utilities and Types

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/types/index.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/types/game.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/types/event.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/types/pick.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/schemas/index.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/schemas/game.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/schemas/pick.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/schemas/event.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/utils/index.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/utils/date.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/shared/utils/string.ts`

**Complexity**: M (3h)

**Dependencies**: Phase 1 (needs TypeScript config)

**Description**:
Port all shared TypeScript types, Zod schemas, and utility functions from `src/types/` and `src/schemas/` to `shared/` directory. These are framework-agnostic and port with minimal changes.

**Implementation Steps**:

1. Copy type definitions:
   - From `/Users/drewritter/projects/bignight.party/src/types/` to `shared/types/`
   - Remove any Next.js-specific types (e.g., `Metadata`)
2. Copy Zod schemas:
   - From `/Users/drewritter/projects/bignight.party/src/schemas/` to `shared/schemas/`
   - These will be used in tRPC procedure inputs (Phase 3)
3. Copy utility functions:
   - From `/Users/drewritter/projects/bignight.party/src/lib/utils/` to `shared/utils/`
   - Remove any Next.js-specific utilities
4. Create barrel exports for each directory:
   - `shared/types/index.ts`
   - `shared/schemas/index.ts`
   - `shared/utils/index.ts`
5. Update imports if needed (mostly unchanged)
6. Run type checking on all shared files
7. Verify utilities are framework-agnostic (manual review)

**Source Files** (copy from old project):
- `src/types/*.ts`
- `src/schemas/*.ts`
- `src/lib/utils/*.ts`

**Acceptance Criteria**:
- [ ] All type files copied to `shared/types/`
- [ ] All Zod schemas copied to `shared/schemas/`
- [ ] All utilities copied to `shared/utils/`
- [ ] Barrel exports created for each directory
- [ ] No Next.js dependencies in shared code
- [ ] TypeScript compilation passes for all shared files
- [ ] Schemas compatible with tRPC input validation

**Mandatory Patterns**:

> **Shared Code**: Framework-agnostic, usable by both client and server

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

## Phase 3: tRPC API Layer

**Strategy**: Sequential
**Reason**: All tasks modify `server/api/trpc.ts` to register routers (shared file dependency)
**Phase Time**: 19h (sequential only)

### Task 3.1: Auth & User tRPC Routers

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/auth.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/user.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/index.ts` (update)

**Complexity**: M (4h)

**Dependencies**: Phase 2 (needs services), Task 1.4 (needs tRPC foundation)

**Description**:
Create tRPC procedures for authentication and user management, replacing Next.js Server Actions with type-safe RPC calls. Includes magic link requests, session management, and user profile operations.

**Implementation Steps**:

1. Create auth router (`server/api/routers/auth.ts`):
   - `auth.requestMagicLink` - Send magic link email (public procedure)
   - `auth.verifyMagicLink` - Verify token and create session (public)
   - `auth.signOut` - Destroy session (protected procedure)
   - `auth.getSession` - Get current user session (public, returns null if not authed)
2. Create user router (`server/api/routers/user.ts`):
   - `user.getProfile` - Get user profile (protected)
   - `user.updateProfile` - Update user profile (protected)
   - `user.delete` - Delete account (protected)
3. Use Zod schemas from `shared/schemas/` for input validation
4. Call services (no direct model access)
5. Register routers in `server/api/routers/index.ts`:
   ```typescript
   export const appRouter = router({
     auth: authRouter,
     user: userRouter,
   })
   ```
6. Test procedures via tRPC playground or manual client calls

**Reference** (Server Actions to replace):
- `src/lib/actions/auth.ts` → `auth` router
- `src/lib/actions/user.ts` → `user` router

**Acceptance Criteria**:
- [ ] Auth router has 4 procedures (requestMagicLink, verify, signOut, getSession)
- [ ] User router has 3 procedures (getProfile, update, delete)
- [ ] All inputs validated with Zod schemas
- [ ] Protected procedures require authentication
- [ ] Routers registered in root router
- [ ] Type inference works (client knows procedure signatures)
- [ ] Manual test: Magic link request returns success

**Mandatory Patterns**:

> **tRPC Procedures**: Use `protectedProcedure` for authenticated routes
> **Input Validation**: All inputs validated with Zod schemas

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

### Task 3.2: Game & Pick tRPC Routers

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/game.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/pick.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/index.ts` (update)

**Complexity**: L (5h)

**Dependencies**: Task 3.1 (needs root router), Phase 2 (needs services)

**Description**:
Create tRPC procedures for game management and pick submission, replacing Next.js Server Actions. This is the core user flow: join game, view categories, submit picks, view leaderboard.

**Implementation Steps**:

1. Create game router (`server/api/routers/game.ts`):
   - `game.getByAccessCode` - Find game by code (public)
   - `game.join` - Join game as participant (protected)
   - `game.getById` - Get game details (protected, verify participant)
   - `game.getCategories` - Get event categories for game (protected)
   - `game.getParticipants` - Get game participants (protected)
   - `game.updateStatus` - Admin-only status transitions (admin procedure)
2. Create pick router (`server/api/routers/pick.ts`):
   - `pick.submit` - Submit pick for category (protected)
   - `pick.getUserPicks` - Get user's picks for game (protected)
   - `pick.validatePicks` - Check if user completed all categories (protected)
3. Use Zod schemas from `shared/schemas/game.ts` and `shared/schemas/pick.ts`
4. Implement authorization checks:
   - User must be game participant to submit picks
   - Game must be OPEN to accept picks
5. Register routers in root router
6. Test via manual client calls

**Reference** (Server Actions to replace):
- `src/lib/actions/game.ts` → `game` router
- `src/lib/actions/pick.ts` → `pick` router

**Acceptance Criteria**:
- [ ] Game router has 6 procedures (getByAccessCode, join, getById, getCategories, getParticipants, updateStatus)
- [ ] Pick router has 3 procedures (submit, getUserPicks, validatePicks)
- [ ] Authorization enforced (participants only)
- [ ] Business rules validated (game status, pick uniqueness)
- [ ] Zod schemas validate all inputs
- [ ] Routers registered in root router
- [ ] Manual test: Join game and submit pick succeeds

**Mandatory Patterns**:

> **Authorization**: Verify game participant before allowing operations
> **Business Rules**: Validate game status before accepting picks

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

### Task 3.3: Admin tRPC Routers

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/admin.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/work.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/person.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/index.ts` (update)

**Complexity**: L (6h)

**Dependencies**: Task 3.2 (needs root router), Phase 2 (needs services)

**Description**:
Create tRPC procedures for admin panel operations: managing events, categories, nominations, works, and people. All procedures require ADMIN role.

**Implementation Steps**:

1. Create admin router (`server/api/routers/admin.ts`):
   - `admin.createEvent` - Create new event (admin)
   - `admin.updateEvent` - Update event (admin)
   - `admin.deleteEvent` - Delete event (admin)
   - `admin.createCategory` - Add category to event (admin)
   - `admin.updateCategory` - Update category (admin)
   - `admin.deleteCategory` - Delete category (admin)
   - `admin.createNomination` - Add nomination (admin)
   - `admin.deleteNomination` - Remove nomination (admin)
   - `admin.markWinner` - Mark category winner (admin, emits WebSocket event)
   - `admin.createGame` - Create game for event (admin)
   - `admin.updateGame` - Update game settings (admin)
   - `admin.deleteGame` - Delete game (admin)
2. Create work router (`server/api/routers/work.ts`):
   - `work.create` - Create work (film, show, album) (admin)
   - `work.update` - Update work (admin)
   - `work.delete` - Delete work (admin)
   - `work.search` - Search works (public)
   - `work.getById` - Get work details (public)
3. Create person router (`server/api/routers/person.ts`):
   - `person.create` - Create person (actor, director) (admin)
   - `person.update` - Update person (admin)
   - `person.delete` - Delete person (admin)
   - `person.search` - Search people (public)
   - `person.getById` - Get person details (public)
4. Use `adminProcedure` middleware for all admin operations
5. Register routers in root router
6. Test admin authorization (non-admin should get 403)

**Reference** (Server Actions to replace):
- `src/lib/actions/admin/*.ts` → `admin` router
- `src/lib/actions/work.ts` → `work` router
- `src/lib/actions/person.ts` → `person` router

**Acceptance Criteria**:
- [ ] Admin router has 12 procedures (event, category, nomination, game CRUD)
- [ ] Work router has 5 procedures (CRUD + search)
- [ ] Person router has 5 procedures (CRUD + search)
- [ ] All admin operations use `adminProcedure` (ADMIN role required)
- [ ] `markWinner` emits WebSocket event (placeholder for Phase 5)
- [ ] Zod schemas validate all inputs
- [ ] Routers registered in root router
- [ ] Manual test: Non-admin gets 403 on admin procedures

**Mandatory Patterns**:

> **Admin Authorization**: Use `adminProcedure` middleware for all admin operations
> **WebSocket Events**: Emit events after state changes (markWinner → category:revealed)

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

### Task 3.4: Event & Category tRPC Routers

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/event.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/category.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/leaderboard.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/api/routers/index.ts` (update)

**Complexity**: M (4h)

**Dependencies**: Task 3.3 (needs root router), Phase 2 (needs services)

**Description**:
Create tRPC procedures for public event/category viewing and leaderboard data. These are read-only operations for game participants.

**Implementation Steps**:

1. Create event router (`server/api/routers/event.ts`):
   - `event.getAll` - List all events (public)
   - `event.getById` - Get event details (public)
   - `event.getCategories` - Get categories for event (public)
   - `event.getNominations` - Get nominations for category (public)
2. Create category router (`server/api/routers/category.ts`):
   - `category.getById` - Get category details (public)
   - `category.getNominations` - Get nominations for category (public)
   - `category.getWinner` - Get winning nomination if revealed (public)
3. Create leaderboard router (`server/api/routers/leaderboard.ts`):
   - `leaderboard.getByGame` - Get leaderboard for game (protected, participant only)
   - `leaderboard.getUserScore` - Get user's score (protected)
4. Register routers in root router
5. Test public access (no auth required for event/category read ops)

**Reference** (Server Actions to replace):
- `src/lib/actions/event.ts` → `event` router
- `src/lib/actions/category.ts` → `category` router
- `src/lib/actions/leaderboard.ts` → `leaderboard` router

**Acceptance Criteria**:
- [ ] Event router has 4 procedures (getAll, getById, getCategories, getNominations)
- [ ] Category router has 3 procedures (getById, getNominations, getWinner)
- [ ] Leaderboard router has 2 procedures (getByGame, getUserScore)
- [ ] Public procedures accessible without auth
- [ ] Leaderboard requires participant authorization
- [ ] Routers registered in root router
- [ ] Manual test: Fetch event list without auth succeeds

**Mandatory Patterns**:

> **Public Procedures**: Event/category viewing requires no authentication
> **Protected Leaderboard**: Only game participants can view leaderboard

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
```

---

## Phase 4: UI & Routes

**Strategy**: Parallel (after Task 4.1)
**Reason**: Route files are independent after shared components created
**Phase Time**: 7h (parallel execution) vs 25h (sequential)
**Time Savings**: 18h (72% faster)

### Task 4.1: Shared UI Components

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/button.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/form.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/input.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/card.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/dialog.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/select.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/ui/toast.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/layout/Header.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/layout/Footer.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/layout/Sidebar.tsx`

**Complexity**: L (6h)

**Dependencies**: Phase 3 (needs tRPC procedures for auth state)

**Description**:
Port shadcn/ui components and shared layout components from Next.js project. These are framework-agnostic React components that work in TanStack Start with minimal changes.

**Implementation Steps**:

1. Copy shadcn/ui primitives from `/Users/drewritter/projects/bignight.party/src/components/ui/`:
   - Button, Form, Input, Card, Dialog, Select, Toast
   - Remove any Next.js-specific props (e.g., `next/link` usage)
2. Update navigation links to use TanStack Router's `<Link>` component:
   - Replace `next/link` with `@tanstack/react-router`
3. Copy layout components from `/Users/drewritter/projects/bignight.party/src/components/layout/`:
   - Header (with auth state), Footer, Sidebar
4. Update Header to use tRPC auth query:
   ```typescript
   const { data: session } = trpc.auth.getSession.useQuery()
   ```
5. Set up Tailwind CSS v4 configuration
6. Install shadcn/ui dependencies (Radix UI primitives)
7. Test components render without errors

**Source Files** (copy from old project):
- `src/components/ui/*.tsx`
- `src/components/layout/*.tsx`

**Acceptance Criteria**:
- [ ] All shadcn/ui primitives copied and functional
- [ ] No Next.js dependencies in components
- [ ] TanStack Router `<Link>` used for navigation
- [ ] Header shows auth state via `trpc.auth.getSession`
- [ ] Tailwind CSS v4 configured and styles apply
- [ ] All components render without console errors
- [ ] Barrel export created (`app/components/index.ts`)

**Mandatory Patterns**:

> **No "use client"**: TanStack Start components are always client-side (no RSC)
> **TanStack Router Links**: Use `<Link>` from `@tanstack/react-router`

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run tsc --noEmit  # No type errors
bun run dev  # Components render without errors
```

---

### Task 4.2: Auth Routes & Pages

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/sign-in.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/verify.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/sign-out.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/__root.tsx`

**Complexity**: M (4h)

**Dependencies**: Task 4.1 (needs UI components), Phase 3 (needs auth procedures)

**Description**:
Create authentication pages for magic link flow: sign-in form, email verification, and sign-out. Implements TanStack Router file-based routing.

**Implementation Steps**:

1. Create sign-in page (`app/routes/sign-in.tsx`):
   - Form with email input
   - Calls `trpc.auth.requestMagicLink.mutate()`
   - Shows success message after email sent
2. Create verify page (`app/routes/verify.tsx`):
   - Reads token from URL query param
   - Calls `trpc.auth.verifyMagicLink.mutate({ token })`
   - Redirects to dashboard on success
3. Create sign-out page (`app/routes/sign-out.tsx`):
   - Calls `trpc.auth.signOut.mutate()`
   - Redirects to home page
4. Create root route (`app/routes/__root.tsx`):
   - Root layout with Header, Footer
   - React Query provider
   - Toast provider
5. Add route guards (authenticated routes redirect to sign-in)
6. Test magic link flow end-to-end

**Reference** (pages to replace):
- `src/app/(auth)/sign-in/page.tsx` → `app/routes/sign-in.tsx`
- `src/app/(auth)/verify/page.tsx` → `app/routes/verify.tsx`

**Acceptance Criteria**:
- [ ] Sign-in form sends magic link email
- [ ] Verify page validates token and creates session
- [ ] Sign-out page destroys session
- [ ] Root route includes layout and providers
- [ ] Routes use TanStack Router conventions
- [ ] Manual test: Complete magic link flow succeeds
- [ ] Auth guards redirect unauthenticated users

**Mandatory Patterns**:

> **Route Guards**: Use `beforeLoad` for auth checks
> **tRPC Mutations**: Use `trpc.auth.*.mutate()` for auth operations

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run dev  # Navigate to /sign-in, form works
```

---

### Task 4.3: Game Routes & Pick Wizard

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/game.$gameId.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/game.$gameId.pick.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/join.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/game/PickWizard.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/game/CategoryCard.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/game/NominationCard.tsx`

**Complexity**: L (7h)

**Dependencies**: Task 4.1 (needs UI components), Phase 3 (needs game/pick procedures)

**Description**:
Create game pages and pick submission wizard. This is the core user experience: join game, view categories, submit picks.

**Implementation Steps**:

1. Create join page (`app/routes/join.tsx`):
   - Form with access code input
   - Calls `trpc.game.getByAccessCode.query({ code })`
   - Calls `trpc.game.join.mutate({ gameId })` on submit
   - Redirects to game page
2. Create game overview page (`app/routes/game.$gameId.tsx`):
   - Fetches game details via `trpc.game.getById.useQuery({ id })`
   - Shows game status, participants, event info
   - "Submit Picks" button (navigates to pick page)
3. Create pick wizard page (`app/routes/game.$gameId.pick.tsx`):
   - Fetches categories via `trpc.game.getCategories.useQuery({ gameId })`
   - Multi-step wizard with category-by-category selection
   - Calls `trpc.pick.submit.mutate()` for each pick
   - Progress indicator
4. Create PickWizard component:
   - Wizard state management (current category, completed categories)
   - Navigation (next, previous, submit)
5. Create CategoryCard and NominationCard components
6. Test pick submission flow end-to-end

**Reference** (pages to replace):
- `src/app/(app)/join/page.tsx` → `app/routes/join.tsx`
- `src/app/(app)/game/[gameId]/page.tsx` → `app/routes/game.$gameId.tsx`
- `src/app/(app)/game/[gameId]/pick/page.tsx` → `app/routes/game.$gameId.pick.tsx`

**Acceptance Criteria**:
- [ ] Join page validates access code and adds user to game
- [ ] Game overview page shows game details
- [ ] Pick wizard displays categories step-by-step
- [ ] User can select nomination for each category
- [ ] Picks submitted successfully via tRPC mutation
- [ ] Progress indicator shows completion status
- [ ] Manual test: Join game and submit all picks succeeds

**Mandatory Patterns**:

> **Route Params**: Access gameId via TanStack Router params
> **tRPC Queries**: Use `useQuery` for data fetching, `useMutation` for picks

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run dev  # Navigate to /join, complete pick flow
```

---

### Task 4.4: Admin Routes & Panels

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/admin.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/admin.events.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/admin.events.$eventId.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/admin.games.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/admin.works.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/admin.people.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/admin/EventForm.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/admin/CategoryForm.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/admin/NominationForm.tsx`

**Complexity**: L (7h)

**Dependencies**: Task 4.1 (needs UI components), Phase 3 (needs admin procedures)

**Description**:
Create admin panel pages for managing events, categories, nominations, works, and people. All routes require ADMIN role.

**Implementation Steps**:

1. Create admin layout route (`app/routes/admin.tsx`):
   - Auth guard (ADMIN role required)
   - Sidebar navigation (Events, Games, Works, People)
2. Create events list page (`app/routes/admin.events.tsx`):
   - Fetches events via `trpc.event.getAll.useQuery()`
   - "Create Event" button
   - Table with edit/delete actions
3. Create event detail page (`app/routes/admin.events.$eventId.tsx`):
   - Fetches event via `trpc.event.getById.useQuery({ id })`
   - Manage categories (create, edit, delete)
   - Manage nominations for each category
   - Mark winners (calls `trpc.admin.markWinner.mutate()`)
4. Create games list page (`app/routes/admin.games.tsx`):
   - Create/manage games for events
5. Create works/people management pages
6. Create reusable form components (EventForm, CategoryForm, etc.)
7. Test admin operations (create event, add categories, mark winner)

**Reference** (pages to replace):
- `src/app/(admin)/admin/events/page.tsx` → `app/routes/admin.events.tsx`
- `src/app/(admin)/admin/events/[eventId]/page.tsx` → `app/routes/admin.events.$eventId.tsx`

**Acceptance Criteria**:
- [ ] Admin layout has auth guard (ADMIN role required)
- [ ] Events list shows all events with CRUD actions
- [ ] Event detail page manages categories and nominations
- [ ] Mark winner button calls tRPC mutation
- [ ] Games, Works, People pages functional
- [ ] Form components reusable and validated
- [ ] Manual test: Create event, add categories, mark winner succeeds

**Mandatory Patterns**:

> **Admin Auth Guard**: Use `beforeLoad` to check ADMIN role
> **tRPC Mutations**: Use admin procedures for all operations

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run dev  # Navigate to /admin, verify auth guard works
```

---

### Task 4.5: Leaderboard & Dashboard

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/game.$gameId.leaderboard.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/dashboard.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/index.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/game/Leaderboard.tsx`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/components/game/ScoreCard.tsx`

**Complexity**: M (5h)

**Dependencies**: Task 4.1 (needs UI components), Phase 3 (needs leaderboard procedures)

**Description**:
Create leaderboard page with real-time score updates and user dashboard showing joined games. Leaderboard updates when winners revealed (Phase 5 adds WebSocket).

**Implementation Steps**:

1. Create leaderboard page (`app/routes/game.$gameId.leaderboard.tsx`):
   - Fetches leaderboard via `trpc.leaderboard.getByGame.useQuery({ gameId })`
   - Displays ranked list of participants with scores
   - Highlights current user
   - Placeholder for WebSocket updates (Phase 5)
2. Create dashboard page (`app/routes/dashboard.tsx`):
   - Fetches user's games (via service)
   - Shows list of joined games with status
   - Quick actions (view game, view leaderboard)
3. Create home page (`app/routes/index.tsx`):
   - Landing page with "Join Game" CTA
   - Redirects to dashboard if authenticated
4. Create Leaderboard component:
   - Sortable participant list
   - Score breakdown by category
5. Create ScoreCard component (individual participant score)
6. Test leaderboard displays correctly

**Reference** (pages to replace):
- `src/app/(app)/game/[gameId]/leaderboard/page.tsx` → `app/routes/game.$gameId.leaderboard.tsx`
- `src/app/(app)/dashboard/page.tsx` → `app/routes/dashboard.tsx`

**Acceptance Criteria**:
- [ ] Leaderboard page fetches and displays scores
- [ ] Participants sorted by score (descending)
- [ ] Current user highlighted
- [ ] Dashboard shows user's games
- [ ] Home page has join game CTA
- [ ] Manual test: Leaderboard updates after marking winner (via refetch)

**Mandatory Patterns**:

> **Real-Time Placeholder**: Leaderboard fetches on mount (WebSocket refetch in Phase 5)
> **Auth Guard**: Dashboard requires authentication

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run dev  # Navigate to leaderboard, scores display
```

---

## Phase 5: Real-Time & Integration

**Strategy**: Sequential
**Reason**: Each task builds on previous (socket → server → tests)
**Phase Time**: 14h (sequential only)

### Task 5.1: Socket.io Server Integration

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/websocket/server.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/server/websocket/handlers.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/hooks/useSocket.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/app/routes/game.$gameId.leaderboard.tsx` (update)

**Complexity**: M (4h)

**Dependencies**: Phase 4 (needs UI routes)

**Description**:
Set up Socket.io server with Bun HTTP server and connect client-side hooks. Enables real-time leaderboard updates when admin marks winners.

**Implementation Steps**:

1. Create Socket.io server (`server/websocket/server.ts`):
   - Attach to Bun HTTP server
   - Game room namespacing (`game:${gameId}`)
   - Better-Auth session validation for connections
2. Create event handlers (`server/websocket/handlers.ts`):
   - `category:revealed` - Emitted when winner marked
   - `game:updated` - Emitted when game status changes
3. Update services to emit events:
   - `adminService.markWinner()` → emit `category:revealed`
4. Create client hook (`app/hooks/useSocket.ts`):
   - Connect to game room
   - Listen for events
   - Invalidate React Query cache on events
5. Update leaderboard page to use socket hook:
   ```typescript
   useSocket(gameId, {
     'category:revealed': () => {
       trpc.leaderboard.getByGame.invalidate()
     }
   })
   ```
6. Test real-time updates: Mark winner → leaderboard updates

**Reference** (WebSocket to port):
- `src/lib/websocket/*.ts` → `server/websocket/`

**Acceptance Criteria**:
- [ ] Socket.io server attached to Bun HTTP server
- [ ] Game rooms isolate events by gameId
- [ ] Better-Auth validates socket connections
- [ ] Services emit events on state changes
- [ ] Client hook connects and listens for events
- [ ] Leaderboard invalidates cache on `category:revealed`
- [ ] Manual test: Mark winner → all clients update leaderboard

**Mandatory Patterns**:

> **Event Namespacing**: Use `game:${gameId}` rooms for isolation
> **Cache Invalidation**: Invalidate React Query on socket events

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run dev  # Mark winner in admin, verify leaderboard updates
```

---

### Task 5.2: Production Server & Build

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/server.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/package.json` (update scripts)
- `/Users/drewritter/projects/bignight.party-no_nextjs/.env.example` (update)

**Complexity**: M (4h)

**Dependencies**: Task 5.1 (needs Socket.io server)

**Description**:
Create production server using TanStack Start reference implementation with Bun. Integrates tRPC HTTP handler and Socket.io server.

**Implementation Steps**:

1. Copy reference `server.ts` from TanStack Start docs:
   - https://tanstack.com/start/latest/docs/framework/react/guide/hosting#bun
2. Integrate tRPC HTTP handler:
   - Mount at `/api/trpc` path
   - Use request context (auth + Prisma)
3. Integrate Socket.io server from Task 5.1
4. Add static file serving (public assets)
5. Add compression and ETag support (from reference)
6. Update package.json scripts:
   - `start` → `bun run server.ts`
   - `build` → `vite build`
7. Test production build:
   - `bun run build` → outputs to `.output/server/index.mjs`
   - `bun run start` → serves production build
8. Verify all endpoints work (tRPC, WebSocket, static files)

**Reference**:
- TanStack Bun hosting: https://tanstack.com/start/latest/docs/framework/react/guide/hosting#bun

**Acceptance Criteria**:
- [ ] Production server starts with `bun run start`
- [ ] Build outputs to `.output/server/index.mjs`
- [ ] tRPC HTTP handler responds at `/api/trpc`
- [ ] Socket.io WebSocket connections work
- [ ] Static files served from `public/`
- [ ] Compression and ETag headers present
- [ ] Manual test: Production build runs all features

**Mandatory Patterns**:

> **Nitro Build**: Vite with Nitro plugin outputs to `.output/server/index.mjs`
> **Bun Server**: Reference implementation from TanStack docs

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run build  # Should succeed
bun run start  # Should serve production build
curl http://localhost:3000/api/trpc  # Should respond
```

---

### Task 5.3: Testing & Quality Gates

**Files**:
- `/Users/drewritter/projects/bignight.party-no_nextjs/tests/e2e/auth.spec.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/tests/e2e/game.spec.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/tests/e2e/admin.spec.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/tests/integration/services.test.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/playwright.config.ts`
- `/Users/drewritter/projects/bignight.party-no_nextjs/vitest.config.ts`

**Complexity**: L (6h)

**Dependencies**: Task 5.2 (needs production build)

**Description**:
Set up testing infrastructure with Vitest (unit/integration) and Playwright (E2E). Port critical tests from Next.js project and adapt for new framework.

**Implementation Steps**:

1. Install test dependencies:
   - `vitest` - Unit/integration test runner
   - `@playwright/test` - E2E test framework
   - `@testing-library/react` - React testing utilities
2. Configure Vitest (`vitest.config.ts`):
   - Path aliases match tsconfig
   - Mock environment variables
3. Configure Playwright (`playwright.config.ts`):
   - Base URL: http://localhost:3000
   - Browsers: Chromium, Firefox
4. Port service tests from old project:
   - `tests/integration/services.test.ts`
   - Test business logic (services + models)
5. Create E2E tests:
   - Auth flow (magic link request → verify → dashboard)
   - Game flow (join → submit picks → view leaderboard)
   - Admin flow (create event → add categories → mark winner)
6. Add quality gate scripts to package.json:
   - `test` → Run all tests
   - `test:e2e` → Run Playwright tests
   - `lint` → Run Biome linting
7. Verify all tests pass

**Reference** (tests to port):
- Service tests from old project (adapt imports)

**Acceptance Criteria**:
- [ ] Vitest configured and unit tests pass
- [ ] Playwright configured and E2E tests pass
- [ ] Auth flow E2E test completes successfully
- [ ] Game flow E2E test completes successfully
- [ ] Admin flow E2E test completes successfully
- [ ] Service integration tests ported and passing
- [ ] Biome linting passes with zero errors
- [ ] All quality gates documented in README

**Mandatory Patterns**:

> **TDD**: Follow test-driven-development skill for new features
> **E2E Coverage**: Test critical user flows end-to-end

**Quality Gates**:
```bash
cd /Users/drewritter/projects/bignight.party-no_nextjs
bun run test  # All tests pass
bun run test:e2e  # E2E tests pass
bun run lint  # Zero errors
```

---

## Summary

This plan migrates BigNight.Party from Next.js to TanStack Start + tRPC + Bun across 5 phases:

1. **Phase 1: Infrastructure** (15h) - Foundation setup (Bun, Vite, Better-Auth, Prisma, tRPC)
2. **Phase 2: Business Logic** (6h parallel) - Port models, services, schemas
3. **Phase 3: API Layer** (19h) - Create tRPC procedures (replaces Server Actions)
4. **Phase 4: UI & Routes** (7h parallel) - Port components and create TanStack Router routes
5. **Phase 5: Integration** (14h) - WebSocket, production server, testing

**Total Time**:
- Sequential: 82 hours
- With Parallelization: 58 hours
- **Time Savings: 24 hours (29% faster)**

**Key Migration Principles**:

- Database schema unchanged (copy Prisma files)
- Business logic unchanged (port services/models)
- Server Actions → tRPC procedures (type-safe API)
- App Router → TanStack Router (file-based)
- Auth.js → Better-Auth (no Edge constraints)
- Next.js → Bun + Vite (fast builds, HMR)

**Next Step**: Execute plan with `/spectacular:execute @specs/04861b-tanstack-migration/plan.md`
