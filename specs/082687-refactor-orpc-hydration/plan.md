---
runId: 082687
feature: refactor-orpc-hydration
created: 2025-01-11
status: ready
---

# Feature: Migrate from Server Actions to oRPC with Clear Hydration Boundaries - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/082687-refactor-orpc-hydration/spec.md
> **Created:** 2025-01-11

## Execution Summary

- **Total Tasks**: 6
- **Total Phases**: 4
- **Sequential Time**: 38h
- **Parallel Time**: 38h
- **Time Savings**: 0h (0%)

**Parallel Opportunities:**
- None (all phases sequential due to dependencies)

**Reasoning:**
This is a fundamental architecture migration that requires strict sequential execution. Each domain (Game → Picks → Admin) depends on the foundation layer, and cleanup requires all domains to be migrated. Attempting parallelization would create merge conflicts and integration issues.

---

## Phase 1: Foundation Infrastructure

**Strategy**: Sequential
**Reason**: Foundation must be in place before any domain migrations

### Task 1.1: oRPC Foundation Setup

**Files**:
- `package.json`
- `pnpm-lock.yaml`
- `src/lib/api/procedures.ts`
- `src/lib/api/server-client.ts`
- `src/lib/api/client.ts`
- `app/api/rpc/[[...rest]]/route.ts`
- `app/providers.tsx`
- `app/layout.tsx`
- `src/lib/api/__tests__/procedures.test.ts`

**Complexity**: L (6h)

**Dependencies**: None

**Description**:
Set up complete oRPC infrastructure including package installation, base procedures (public, authenticated, admin), server-side client for RSC, HTTP client for Client Components, Next.js API route handler, and TanStack Query provider. This establishes the foundational API layer that all domain migrations will build upon.

**Implementation Steps**:

1. Install oRPC dependencies and remove next-safe-action
   ```bash
   pnpm add @orpc/server @orpc/contract @orpc/client @orpc/next @orpc/tanstack-query @tanstack/react-query
   pnpm remove next-safe-action
   ```

2. Create base procedures in `src/lib/api/procedures.ts`:
   - `publicProcedure` - No auth required
   - `authenticatedProcedure` - Uses `requireValidatedSession()` middleware
   - `adminProcedure` - Uses `requireValidatedSession()` + admin role check
   - Context type: `{ userId?: string, userRole?: string, userEmail?: string }`

3. Create server-side client in `src/lib/api/server-client.ts`:
   - Import root router (placeholder initially)
   - Export `serverClient` that calls procedures directly (no HTTP)
   - Type-safe procedure access

4. Create HTTP client in `src/lib/api/client.ts`:
   - Configure HTTP client pointing to `/api/rpc`
   - Export typed client for Client Components
   - Integrate with TanStack Query

5. Create Next.js API route handler in `app/api/rpc/[[...rest]]/route.ts`:
   - Use `@orpc/next` adapter
   - Handle POST requests to oRPC procedures
   - Connect to root router

6. Create providers in `app/providers.tsx`:
   - TanStack QueryClientProvider
   - Configure default query/mutation options
   - Wrap children

7. Update `app/layout.tsx`:
   - Import and wrap with `<Providers>`
   - Maintain existing structure

8. Write tests for procedures:
   - Test auth middleware (authenticated, admin)
   - Test context flow
   - Test error handling

**Acceptance Criteria**:

- [ ] All oRPC packages installed, next-safe-action removed
- [ ] Base procedures (public, authenticated, admin) created and tested
- [ ] Server-side client exports typed client for RSC
- [ ] HTTP client exports typed client for Client Components
- [ ] API route handler responds to POST /api/rpc/* requests
- [ ] TanStack Query provider wraps app in layout
- [ ] All tests pass (`pnpm test src/lib/api`)
- [ ] Lint passes (`pnpm biome check --write .`)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Authentication**: Use `requireValidatedSession()` from @/lib/auth/config (patterns.md)
- **Validation**: Zod schemas at contract level (patterns.md)
- **Type Safety**: End-to-end type inference, no `as` assertions (patterns.md)
- **Testing**: TDD - write test first, watch fail, minimal code, watch pass (testing.md)

**Quality Gates**:

```bash
pnpm biome check --write .
pnpm test src/lib/api
pnpm build
```

---

## Phase 2: Game Domain Migration

**Strategy**: Sequential
**Reason**: Depends on Phase 1 foundation

### Task 2.1: Game Domain oRPC Migration

**Files**:
- `src/lib/api/contracts/game.ts`
- `src/lib/api/routers/game.ts`
- `src/lib/api/root.ts`
- `src/schemas/game-schema.ts`
- `src/app/dashboard/page.tsx`
- `src/app/join/[code]/page.tsx`
- `src/app/game/[gameId]/leaderboard/page.tsx`
- `src/components/game-list-item.tsx`
- `src/components/game/leaderboard/leaderboard-client.tsx`
- `src/lib/api/__tests__/game-router.test.ts`

**Complexity**: L (7h)

**Dependencies**: Task 1.1 (requires oRPC foundation)

**Description**:
Migrate all game-related functionality from Server Actions to oRPC. Define game contracts (list, join, getLeaderboard), implement routers calling existing game services, update Server Components to use `serverClient.game.*`, and update Client Components to use `orpc.game.*.useMutation()`. This demonstrates the full RSC → oRPC → Service flow and establishes the pattern for subsequent domain migrations.

**Implementation Steps**:

1. Define game contracts in `src/lib/api/contracts/game.ts`:
   - `list()` - Get user's games (authenticated)
   - `join(code)` - Join game by access code (authenticated)
   - `getLeaderboard(gameId)` - Get leaderboard data (authenticated)
   - Use existing Zod schemas from `src/schemas/game-schema.ts`
   - Define output types

2. Implement game router in `src/lib/api/routers/game.ts`:
   - Import game contracts
   - Implement procedures calling `gameService.*`
   - Handle errors and validation
   - Use authenticated procedures

3. Create root router in `src/lib/api/root.ts`:
   - Combine all domain routers (start with game)
   - Export router type for clients
   - Export router instance

4. Update Server Components to use `serverClient`:
   - `src/app/dashboard/page.tsx` - Replace service calls with `await serverClient.game.list()`
   - `src/app/join/[code]/page.tsx` - Use server-side validation
   - `src/app/game/[gameId]/leaderboard/page.tsx` - Fetch via `serverClient.game.getLeaderboard()`
   - Remember: `await params` for Next.js 15

5. Update Client Components to use oRPC:
   - `src/components/game-list-item.tsx` - Use `orpc.game.join.useMutation()` if needed
   - `src/components/game/leaderboard/leaderboard-client.tsx` - Combine oRPC queries + Socket.io listeners
   - TanStack Query cache invalidation on socket events

6. Write tests for game router:
   - Test contracts independently
   - Test procedures with mock services
   - Test error cases

**Acceptance Criteria**:

- [ ] Game contracts defined (list, join, getLeaderboard)
- [ ] Game router implemented calling gameService
- [ ] Root router exports combined routers
- [ ] Server Components use `serverClient.game.*` (no HTTP overhead)
- [ ] Client Components use `orpc.game.*.useMutation()` or `useQuery()`
- [ ] Socket.io integration preserved (TanStack Query invalidation)
- [ ] All game features work end-to-end
- [ ] All tests pass (`pnpm test src/lib/api/routers/game`)
- [ ] Lint passes (`pnpm biome check --write .`)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Async params**: Always `await params` in Next.js 15 (patterns.md)
- **Routes**: Use `routes.game.*` from @/lib/routes (patterns.md)
- **Component boundaries**: Server Components compose, Client Components interact (patterns.md)
- **TDD**: Test contracts, then implementation (testing.md)

**Quality Gates**:

```bash
pnpm biome check --write .
pnpm test src/lib/api
pnpm build
pnpm dev # Manual test: Dashboard, Join game, Leaderboard
```

---

## Phase 3: Picks Domain Migration

**Strategy**: Sequential
**Reason**: Depends on Phase 1 foundation

### Task 3.1: Picks Domain oRPC Migration

**Files**:
- `src/lib/api/contracts/pick.ts`
- `src/lib/api/routers/pick.ts`
- `src/lib/api/root.ts`
- `src/schemas/pick-schema.ts`
- `src/app/game/[gameId]/pick/page.tsx`
- `src/components/game/pick-wizard/index.tsx`
- `src/components/game/pick-wizard/nomination-list.tsx`
- `src/components/game/pick-wizard/save-indicator.tsx`
- `src/lib/api/__tests__/pick-router.test.ts`

**Complexity**: L (6h)

**Dependencies**: Task 1.1 (requires oRPC foundation)

**Description**:
Migrate picks wizard and submission flow from Server Actions to oRPC. Define pick contracts (getPicks, submitPick, updatePick), implement routers, update pick wizard to use oRPC mutations with optimistic updates, and integrate save indicators with TanStack Query mutation states. This demonstrates complex client-side interactions with mutations and real-time feedback.

**Implementation Steps**:

1. Define pick contracts in `src/lib/api/contracts/pick.ts`:
   - `getPicks(gameId)` - Get user's picks for game (authenticated)
   - `submitPick({ gameId, categoryId, nominationId })` - Submit pick (authenticated)
   - `updatePick({ pickId, nominationId })` - Update pick (authenticated)
   - Use existing Zod schemas from `src/schemas/pick-schema.ts`
   - Define output types

2. Implement pick router in `src/lib/api/routers/pick.ts`:
   - Import pick contracts
   - Implement procedures calling `pickService.*`
   - Handle validation and errors
   - Use authenticated procedures

3. Update root router in `src/lib/api/root.ts`:
   - Add pick router to combined routers
   - Export updated router type

4. Update Server Component to use `serverClient`:
   - `src/app/game/[gameId]/pick/page.tsx` - Fetch picks via `await serverClient.pick.getPicks()`
   - Pass picks as props to wizard

5. Update Client Components to use oRPC:
   - `src/components/game/pick-wizard/index.tsx` - Use `orpc.pick.submitPick.useMutation()`
   - `src/components/game/pick-wizard/nomination-list.tsx` - Use `orpc.pick.updatePick.useMutation()`
   - Implement optimistic updates for instant feedback
   - `src/components/game/pick-wizard/save-indicator.tsx` - Show mutation state (pending, success, error)

6. Write tests for pick router:
   - Test contracts
   - Test procedures with mock services
   - Test validation (picks locked, duplicate picks)

**Acceptance Criteria**:

- [ ] Pick contracts defined (getPicks, submitPick, updatePick)
- [ ] Pick router implemented calling pickService
- [ ] Root router includes pick router
- [ ] Server Component uses `serverClient.pick.getPicks()`
- [ ] Client Components use `orpc.pick.*.useMutation()` with optimistic updates
- [ ] Save indicator reflects mutation state
- [ ] All picks features work end-to-end
- [ ] All tests pass (`pnpm test src/lib/api/routers/pick`)
- [ ] Lint passes (`pnpm biome check --write .`)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Async params**: Always `await params` in Next.js 15 (patterns.md)
- **Routes**: Use `routes.game.pick()` from @/lib/routes (patterns.md)
- **Optimistic updates**: Use TanStack Query's optimistic mutation pattern (patterns.md)
- **TDD**: Test pick submission, validation, error cases (testing.md)

**Quality Gates**:

```bash
pnpm biome check --write .
pnpm test src/lib/api
pnpm build
pnpm dev # Manual test: Pick wizard, submit picks, update picks
```

---

## Phase 4: Admin Domain Migration & Cleanup

**Strategy**: Sequential
**Reason**: Admin depends on foundation; cleanup requires all domains migrated

### Task 4.1: Admin Domain oRPC Migration

**Files**:
- `src/lib/api/contracts/admin.ts`
- `src/lib/api/routers/admin.ts`
- `src/lib/api/root.ts`
- `src/schemas/event-schema.ts`
- `src/schemas/category-schema.ts`
- `src/schemas/nomination-schema.ts`
- `src/schemas/person-schema.ts`
- `src/schemas/work-schema.ts`
- `src/schemas/wikipedia-import-schema.ts`
- All `src/app/(admin)/**/*.tsx` pages (18+ files)
- All `src/components/admin/**/*.tsx` components (30+ files)
- `src/lib/api/__tests__/admin-router.test.ts`

**Complexity**: L (8h)

**Dependencies**: Task 1.1 (requires oRPC foundation)

**Description**:
Migrate all admin functionality from Server Actions to oRPC. Define admin contracts for events, categories, nominations, people, works, games, and Wikipedia import. Implement routers using admin procedures, update all admin Server Components to use `serverClient.admin.*`, and update all admin Client Components to use `orpc.admin.*.useMutation()`. This is the largest domain with CRUD operations across multiple resources.

**Implementation Steps**:

1. Define admin contracts in `src/lib/api/contracts/admin.ts`:
   - Event operations: `listEvents()`, `createEvent()`, `updateEvent()`, `deleteEvent()`
   - Category operations: `createCategory()`, `updateCategory()`, `deleteCategory()`
   - Nomination operations: `createNomination()`, `deleteNomination()`, `markWinner()`
   - Person operations: `listPeople()`, `createPerson()`, `updatePerson()`, `deletePerson()`
   - Work operations: `listWorks()`, `createWork()`, `updateWork()`, `deleteWork()`
   - Game operations: `listGames()`, `createGame()`, `updateGame()`, `updateGameStatus()`
   - Wikipedia import: `importFromWikipedia()`
   - Use existing Zod schemas from `src/schemas/`
   - All use admin procedures

2. Implement admin router in `src/lib/api/routers/admin.ts`:
   - Import admin contracts
   - Implement procedures calling `adminService.*`, `eventService.*`, `categoryService.*`, etc.
   - Handle validation and errors
   - Use admin procedures (role check)

3. Update root router in `src/lib/api/root.ts`:
   - Add admin router to combined routers
   - Export final router type

4. Update admin Server Components (18+ files):
   - Events: `src/app/(admin)/admin/events/**/*.tsx` - Use `serverClient.admin.listEvents()`, etc.
   - Categories: `src/app/(admin)/admin/events/[id]/categories/**/*.tsx`
   - Games: `src/app/(admin)/admin/games/**/*.tsx`
   - People: `src/app/(admin)/admin/people/**/*.tsx`
   - Works: `src/app/(admin)/admin/works/**/*.tsx`
   - Import: `src/app/(admin)/admin/import/page.tsx`
   - Remember: `await params` for all dynamic routes

5. Update admin Client Components (30+ files):
   - Forms: `src/components/admin/*/\*-form.tsx` - Use `orpc.admin.*.useMutation()`
   - Lists: `src/components/admin/*/\*-list.tsx` - Use `orpc.admin.*.useQuery()` or receive via props
   - Managers: `src/components/admin/*/\*-manager.tsx` - Combine queries + mutations
   - Import wizard: `src/components/admin/import/*` - Use streaming mutations if needed
   - Dialogs: Update confirm dialogs to use mutations

6. Write tests for admin router:
   - Test all contracts
   - Test procedures with mock services
   - Test admin role enforcement
   - Test validation and error cases

**Acceptance Criteria**:

- [ ] Admin contracts defined for all resources (events, categories, nominations, people, works, games, import)
- [ ] Admin router implemented calling appropriate services
- [ ] Root router includes admin router
- [ ] All admin Server Components use `serverClient.admin.*`
- [ ] All admin Client Components use `orpc.admin.*.useMutation()` or `useQuery()`
- [ ] Admin role enforcement works (only ADMIN users can call)
- [ ] All admin features work end-to-end (CRUD for all resources)
- [ ] Wikipedia import works with progress feedback
- [ ] All tests pass (`pnpm test src/lib/api/routers/admin`)
- [ ] Lint passes (`pnpm biome check --write .`)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Async params**: Always `await params` in Next.js 15 (patterns.md)
- **Routes**: Use `routes.admin.*` from @/lib/routes (patterns.md)
- **Admin auth**: Use admin procedures with role check (patterns.md)
- **Form handling**: Inline form actions for no-redirect, standalone for redirects (patterns.md)
- **TDD**: Test CRUD operations, role enforcement (testing.md)

**Quality Gates**:

```bash
pnpm biome check --write .
pnpm test src/lib/api
pnpm build
pnpm dev # Manual test: All admin pages and operations
```

---

### Task 4.2: Auth Domain oRPC Migration

**Files**:
- `src/lib/api/contracts/auth.ts`
- `src/lib/api/routers/auth.ts`
- `src/lib/api/root.ts`
- `src/schemas/auth-schema.ts`
- `src/app/(auth)/sign-in/page.tsx`
- `src/app/signup/page.tsx`
- `src/app/signup/callback/page.tsx`
- `src/lib/api/__tests__/auth-router.test.ts`

**Complexity**: M (4h)

**Dependencies**: Task 1.1 (requires oRPC foundation)

**Description**:
Migrate authentication flows from Server Actions to oRPC. Define auth contracts (signIn, signUp, verifyEmail), implement routers, and update auth pages. This is a smaller domain but critical for user onboarding.

**Implementation Steps**:

1. Define auth contracts in `src/lib/api/contracts/auth.ts`:
   - `signIn(email)` - Request magic link (public)
   - `signUp(email)` - Create account and send magic link (public)
   - `verifyEmail(token)` - Verify email token (public)
   - Use existing Zod schemas from `src/schemas/auth-schema.ts`

2. Implement auth router in `src/lib/api/routers/auth.ts`:
   - Import auth contracts
   - Implement procedures (use public procedures, not authenticated)
   - Call existing auth services or integrate with Auth.js

3. Update root router in `src/lib/api/root.ts`:
   - Add auth router to combined routers

4. Update auth pages:
   - `src/app/(auth)/sign-in/page.tsx` - Use `orpc.auth.signIn.useMutation()` in Client Component
   - `src/app/signup/page.tsx` - Use `orpc.auth.signUp.useMutation()`
   - `src/app/signup/callback/page.tsx` - Use `serverClient.auth.verifyEmail()` if needed

5. Write tests for auth router:
   - Test sign in flow
   - Test sign up flow
   - Test email verification

**Acceptance Criteria**:

- [ ] Auth contracts defined (signIn, signUp, verifyEmail)
- [ ] Auth router implemented
- [ ] Root router includes auth router
- [ ] Auth pages use oRPC mutations
- [ ] All auth features work end-to-end
- [ ] All tests pass (`pnpm test src/lib/api/routers/auth`)
- [ ] Lint passes (`pnpm biome check --write .`)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Routes**: Use `routes.auth.*` from @/lib/routes (patterns.md)
- **Validation**: Zod schemas for email validation (patterns.md)
- **TDD**: Test auth flows, token validation (testing.md)

**Quality Gates**:

```bash
pnpm biome check --write .
pnpm test src/lib/api
pnpm build
pnpm dev # Manual test: Sign in, sign up, email verification
```

---

### Task 4.3: Server Actions Cleanup & Constitution Update

**Files**:
- `src/lib/actions/` (delete entire directory)
- `package.json`
- `docs/constitutions/current/architecture.md`
- `docs/constitutions/current/patterns.md`
- `docs/constitutions/current/tech-stack.md`
- `CLAUDE.md`

**Complexity**: M (3h)

**Dependencies**: Tasks 2.1, 3.1, 4.1, 4.2 (all domains migrated)

**Description**:
Remove all Server Actions code, delete `next-safe-action` dependency, update constitution to reflect new oRPC architecture, and update CLAUDE.md with new patterns. This completes the migration and establishes oRPC as the standard going forward.

**Implementation Steps**:

1. Verify all Server Actions are unused:
   - Search codebase for `useAction` imports
   - Search for references to `src/lib/actions/`
   - Ensure all components use oRPC

2. Delete Server Actions:
   - Remove `src/lib/actions/` directory entirely
   - Verify no broken imports

3. Update package.json:
   - Confirm `next-safe-action` removed
   - Verify oRPC packages listed

4. Update constitution architecture.md:
   - Change layer diagram: Remove "Server Actions" layer
   - Add "oRPC Procedures" layer
   - Update layer boundaries (Components → oRPC → Services → Models)
   - Document server-side vs HTTP client usage

5. Update constitution patterns.md:
   - Remove next-safe-action pattern
   - Add oRPC contract-first pattern
   - Add server-side client pattern (RSC)
   - Add HTTP client pattern (Client Components)
   - Add TanStack Query mutation pattern
   - Update async params examples to use oRPC

6. Update constitution tech-stack.md:
   - Remove `next-safe-action`
   - Add oRPC packages (`@orpc/*`)
   - Add `@tanstack/react-query`

7. Update CLAUDE.md:
   - Remove Server Actions guidance
   - Add oRPC patterns section
   - Update "Mandatory Patterns" to use oRPC
   - Update architecture diagram
   - Add hydration boundary guidance (serverClient vs HTTP client)

8. Run full test suite and build:
   - Ensure all tests pass
   - Ensure build succeeds
   - Manual smoke test all features

**Acceptance Criteria**:

- [ ] `src/lib/actions/` directory deleted
- [ ] No references to `useAction` or Server Actions in codebase
- [ ] `next-safe-action` removed from package.json
- [ ] Constitution architecture.md updated with oRPC layer
- [ ] Constitution patterns.md documents oRPC patterns
- [ ] Constitution tech-stack.md lists oRPC packages
- [ ] CLAUDE.md updated with oRPC guidance
- [ ] All tests pass (`pnpm test`)
- [ ] Build succeeds (`pnpm build`)
- [ ] Lint passes (`pnpm biome check --write .`)
- [ ] Manual smoke test of all features passes

**Mandatory Patterns**:

> **Constitution**: Update constitution to reflect new patterns

- **Documentation**: Clear, concise updates to all constitution files
- **Completeness**: No references to old patterns remain
- **Verification**: Full test suite + build confirms migration complete

**Quality Gates**:

```bash
# Search for any remaining Server Actions references
grep -r "useAction" src/
grep -r "next-safe-action" .
grep -r "src/lib/actions" src/

# Full verification
pnpm biome check --write .
pnpm test
pnpm build
pnpm dev # Manual test: All features (dashboard, game, picks, admin)
```

---

## Migration Notes

### Coexistence Strategy

During Phases 2-4, both Server Actions and oRPC will coexist:

- Server Actions remain in `src/lib/actions/` until Task 4.3
- New oRPC code in `src/lib/api/`
- No reverse compatibility needed after completion
- Clean cutover per domain

### Rollback Strategy

If issues arise:

- Each task is a complete, mergeable PR
- Can pause migration and operate with partial oRPC adoption
- Task 4.3 (cleanup) is final commit point
- Before Task 4.3, can revert individual domain migrations

### Testing Strategy

Per task:

1. Unit tests for contracts (input/output validation)
2. Integration tests for routers (procedures with mock services)
3. Component tests (mock oRPC client)
4. Manual smoke tests for features

Per phase:

- Full test suite must pass
- Build must succeed
- Lint must pass
- Manual feature verification

### Performance Considerations

- **Server-side calls**: Zero HTTP overhead (direct function calls)
- **HTTP calls**: TanStack Query caching reduces redundant requests
- **Real-time**: Socket.io unchanged, TanStack Query invalidation on events
- **Bundle size**: Monitor impact of oRPC + TanStack Query packages

### Developer Onboarding

After migration:

- Update CLAUDE.md with clear oRPC patterns
- Document hydration boundary decisions (when to use serverClient vs HTTP client)
- Provide examples of common patterns (mutations, queries, optimistic updates)
- Update contribution guide with contract-first workflow

---

## Constitution References

> **All tasks MUST follow**: @docs/constitutions/current/

**Architecture**:

- Layer boundaries (architecture.md)
- Will be updated in Task 4.3

**Patterns**:

- Async params (patterns.md)
- Centralized routes (patterns.md)
- requireValidatedSession (patterns.md)
- ts-pattern for discriminated unions (patterns.md)
- Zod validation (patterns.md)
- Will be updated in Task 4.3

**Tech Stack**:

- Approved libraries (tech-stack.md)
- Will be updated in Task 4.3

**Testing**:

- TDD requirements (testing.md)
- Test structure and coverage (testing.md)
